# كيفية ظهور سكشن "المشروعات ذات الصلة"

يعتمد ظهور سكشن "المشروعات ذات الصلة" في صفحة المشروع الفردي على سلسلة خطوات داخل الدالة `get_my_related_projects()`، تم تصميمها لمنع بقاء أي صفحة مشروع دون روابط داعمة:

1. **التحقق من الفئة الرئيسية**
   - تُقرأ قيمة الحقل `jawda_main_category_id` للمشروع الحالي، ولا يتم تنفيذ أي منطق لاحق إن لم تكن القيمة موجودة لأن جميع النتائج يجب أن تنتمي لنفس الفئة.

2. **جمع كل المشروعات فى الفئة**
   - تُنفّذ استعلام واحد على نوع المحتوى `projects` يعيد جميع المعرفات المنشورة فى نفس الفئة الرئيسية بترتيب زمنى تصاعدى (الأقدم أولًا). تتم إعادة ضبط بيانات الاستعلام فورًا بعد الحصول على القائمة.

3. **تحديد موضع المشروع الحالى**
   - يُحَدَّد رقم فهرس المشروع الحالى داخل القائمة الكاملة. إذا لم يُعثر عليه يتم الإنهاء لحماية التنفيذ من نتائج غير متوقعة.

4. **التنقل الحلقى حسب الموقع**
   - يتم بناء دالة مساعدة تمر على القائمة مرتين: أولًا للخلف من المشروع الحالى لجمع المشروعات الأقدم، ثم تلتف إلى نهاية القائمة وتعود للخلف نحو أحدث العناصر. يتم استبعاد المعرفات المكررة أو المختارة سابقًا.
   - تُنفّذ هذه الدالة على مستويات الموقع بالتسلسل: الحى (`loc_district_id`) ثم المدينة (`loc_city_id`) ثم المحافظة (`loc_governorate_id`). فى كل مستوى لا تُضاف سوى المشروعات التى تشترك فى نفس المعرّف الجغرافى مع المشروع الحالى.

5. **ملء أى نقص عبر الفئة نفسها**
   - إذا ظل العدد أقل من خمسة بعد المرور على كل مستويات الموقع، يُستكمل النقص باستخدام نفس الدالة المساعدة ولكن بدون شرط موقع، مع الحفاظ على ترتيب الأقدم ثم الالتفاف إلى الأحدث. بذلك نتأكد من عدم بقاء السكشن فارغًا حتى فى حال غياب بيانات الموقع أو ندرة النتائج.

6. **عرض البطاقات والعنوان**
   - تُنظَّف النتائج من التكرارات ثم يُحتفظ بأول خمسة عناصر فقط. إذا كانت القائمة غير فارغة يُولّد العنوان الدينامى بالاعتماد على اسم الفئة الرئيسية من جدول `property_categories`، ثم تُطبع البطاقات عبر القالب `get_my_project_box()`.

بهذا التسلسل الذى يجمع بين أولوية الموقع والترتيب الزمنى الحلقى، تحصل كل صفحة مشروع على ما يصل إلى خمسة روابط ذات صلة، مع ضمان توزيع المشروعات على الصفحات المختلفة دون ترك صفحات يتيمة.
