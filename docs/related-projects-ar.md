# كيفية ظهور سكشن "المشروعات ذات الصلة"

يستند عرض سكشن "المشروعات ذات الصلة" فى صفحات المشاريع الفردية إلى منطق بسيط يعتمد على الفئة الرئيسية للمشروع الحالى ثم يتدرج عبر مستويات الموقع الجغرافى قبل إظهار النتائج.

1. **تجميع بيانات المشروع الحالى**
   - تُقرأ معرفات الموقع (`loc_district_id`، `loc_city_id`، `loc_governorate_id`) بالإضافة إلى قيمة الحقل `jawda_main_category_id` وأى تصنيفات `project_category` مرتبطة بالمشروع.

2. **تجهيز الاستعلام الأساسى**
   - يُنشأ كائن استعلام يركز على نوع المحتوى `projects`، ويستبعد المشروع الحالى، ويجلب فقط العناصر المنشورة قبل تاريخ نشره. إذا وُجدت فئة من `project_category` تُضاف إلى شرط `tax_query`، وإذا توافرت قيمة `jawda_main_category_id` تُضاف إلى `meta_query` لضمان تطابق الفئة الرئيسية.

3. **اختيار مشروعات بنفس الموقع**
   - دالة المساعدة `collect_related_projects()` تنسخ الاستعلام الأساسى وتضيف شرط الموقع المطلوب (`loc_district_id` ثم `loc_city_id` ثم `loc_governorate_id`).
   - تُنفّذ الدالة بالتتابع مع تحديث عدد العناصر المطلوبة (بحد أقصى خمسة) مع استبعاد أى معرفات تم اختيارها سابقًا حتى لا تتكرر النتائج.

4. **جمع مشروعات أخرى داخل نفس المدينة**
   - بعد ملء قائمة "المشروعات المشابهة" حسب الحى/المدينة/المحافظة، يتم استدعاء الدالة نفسها مرة أخرى بنفس معرّف المدينة لكن مع قائمة استبعاد تشمل المشروع الحالى وكل النتائج السابقة، وذلك لإظهار قسم إضافى بعنوان "مشروعات أخرى" عند توافر نتائج.

5. **شروط إظهار السكشن والعناوين**
   - لا يُطبع أى HTML ما لم توجد نتائج فى `$similar_project_ids` أو `$other_city_project_ids`.
   - عند توافر نتائج، يُستخرج اسم الفئة الرئيسية من جدول `property_categories` (أو من أول تصنيف `project_category` كخيار احتياطى) ويُجلب اسم المدينة من جدول `locations_cities` لتكوين العناوين بالصيغة العربية أو الإنجليزية حسب لغة الواجهة.

باتباع هذه الخطوات يظهر السكشن عند العثور على مشروعات منشورة سابقة تشترك مع المشروع الحالى فى الفئة الرئيسية وتشارك على الأقل مستوى واحدًا من مستويات الموقع الجغرافى، مع الحفاظ على ترتيب النشر المتسلسل ومنع تكرار النتائج عبر الأقسام المختلفة.
